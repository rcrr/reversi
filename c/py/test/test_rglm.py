#
# test_rglm.py
#
# This file is part of the reversi program
# http://github.com/rcrr/reversi
# 
# Aauthor Roberto Corradini mailto:rob_corradini@yahoo.it
# Copyright 2022 Roberto Corradini. All rights reserved.
#
# License
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 3, or (at your option) any
# later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
# or visit the site <http://www.gnu.org/licenses/>.
#

import unittest

import reversi
import reversi.board
import reversi.pattern
import reversi.regab
import reversi.rglm

from reversi.board import *
from reversi.pattern import *
from reversi.regab import *
from reversi.rglm import *

import numpy as np
import pandas as pd

import duckdb as db

class TestRglm(unittest.TestCase):

    def setUp(self):
        
        create_table = \
        """
        CREATE TABLE regab_prng_gp (seq                       INTEGER,
                                    batch_id                  INTEGER,
                                    game_id                   INTEGER,
                                    pos_id                    INTEGER,
                                    ins_time                  TIMESTAMP,
                                    status                    CHARACTER(3),
                                    cst_time                  TIMESTAMP,
                                    mover                     BIGINT,
                                    opponent                  BIGINT,
                                    player                    SMALLINT,
                                    empty_count               SMALLINT,
                                    legal_move_set            BIGINT,
                                    legal_move_count          SMALLINT,
                                    legal_move_count_adjusted SMALLINT,
                                    parent_move               CHARACTER(2),
                                    game_value                SMALLINT,
                                    best_move                 CHARACTER(2),
                                    leaf_count                BIGINT,
                                    node_count                BIGINT,
                                    parent_gp_id              BIGINT,
                                    solver                    CHARACTER(2));
        """
        
        #   seq    | batch_id | game_id | pos_id |          ins_time          | status |          cst_time          |        mover         |       opponent       | player | empty_count |    legal_move_set    | legal_move_count | legal_move_count_adjusted | parent_move | game_value | best_move | leaf_count | node_count | parent_gp_id | solver 
        #----------+----------+---------+--------+----------------------------+--------+----------------------------+----------------------+----------------------+--------+-------------+----------------------+------------------+---------------------------+-------------+------------+-----------+------------+------------+--------------+--------
        # 93262034 |        7 |       2 |    139 | 2019-04-22 19:28:32.566238 | CMR    | 2019-04-22 19:28:32.566238 |    73552741720267792 | -1670782510033747836 |      0 |          20 |  1161928703928696896 |                4 |                         4 | H3          |        -38 | UN        |          0 |          0 |     68230178 | 
        # 93262035 |        7 |       0 |    139 | 2019-04-22 19:28:32.568927 | CMR    | 2019-04-22 19:28:32.568927 |  4645565179940044804 | -7925171974899468168 |      0 |          20 |   289075900593604224 |                8 |                         8 | E1          |        -10 | UN        |          0 |          0 |     68230055 | 
        # 93262036 |        7 |       1 |    139 | 2019-04-22 19:28:32.571594 | CMR    | 2019-04-22 19:28:32.571594 |    72342959236796672 |  6952639132173607936 |      0 |          20 | -7024982091410407330 |               15 |                        15 | F2          |         34 | UN        |          0 |          0 |     68230116 | 
        # 93262037 |        7 |       3 |    139 | 2019-04-22 19:28:32.573972 | CMR    | 2019-04-22 19:28:32.573972 | -7305726066365030399 |  6944590345854207748 |      0 |          20 |      565175824455810 |               11 |                        11 | A3          |          8 | UN        |          0 |          0 |     68230239 | 
        # 93262038 |        7 |       4 |    139 | 2019-04-22 19:28:32.576182 | CMR    | 2019-04-22 19:28:32.576182 |   222399332786127872 |  -549403436748297664 |      0 |          20 |    36099715523285273 |               10 |                        10 | F5          |        -16 | UN        |          0 |          0 |     68230300 | 
        # 93262039 |        7 |       5 |    139 | 2019-04-22 19:28:32.578391 | CMR    | 2019-04-22 19:28:32.578391 | -9150711684790255104 |  4355151575169109048 |      0 |          20 |  4615345751470403590 |               11 |                        11 | D8          |          6 | UN        |          0 |          0 |     68230361 | 
        # 93262040 |        7 |       6 |    139 | 2019-04-22 19:28:32.580585 | CMR    | 2019-04-22 19:28:32.580585 |  2601038192983711808 |  4620975832368352530 |      0 |          20 | -9205357638345273332 |                6 |                         6 | A3          |        -22 | UN        |          0 |          0 |     68230422 | 
        # 93262041 |        7 |       7 |    139 | 2019-04-22 19:28:32.582653 | CMR    | 2019-04-22 19:28:32.582653 | -9200314147721445312 |  8646929942227861298 |      0 |          20 |   288230379377197069 |                8 |                         8 | F1          |          2 | UN        |          0 |          0 |     68230484 | 
        # 93262042 |        7 |       8 |    139 | 2019-04-22 19:28:32.584767 | CMR    | 2019-04-22 19:28:32.584767 |  1443650452906609182 |   154281338464772384 |      0 |          20 |  2383249729468302400 |               10 |                        10 | F1          |        -10 | UN        |          0 |          0 |     68230545 | 
        # 93262043 |        7 |       9 |    139 | 2019-04-22 19:28:32.586884 | CMR    | 2019-04-22 19:28:32.586884 |     4555813292851584 |      211110762659439 |      0 |          20 |    54043204135157776 |                5 |                         5 | A5          |        -20 | UN        |          0 |          0 |     68230606 | 
        # 68230056 |        7 |       0 |     40 | 2018-01-03 16:38:51.098362 | CMS    | 2019-04-22 19:28:30.7855   |  4611717676283199524 | -7855295674223658936 |      0 |          20 |  3171520399607465616 |               13 |                        13 | H7          |         10 | F8        |    8265202 |   45798972 |              | es  
        # 68230179 |        7 |       2 |     40 | 2018-01-03 16:38:51.107351 | CMS    | 2019-04-22 19:28:30.79057  |    73548482186484752 | -1670215300554932092 |      0 |          20 |  1596526067978346560 |                9 |                         9 | B7          |        -22 | H3        |    6488992 |   38225062 |              | es  
        # 68230240 |        7 |       3 |     40 | 2018-01-03 16:38:51.111269 | CMS    | 2019-04-22 19:28:30.792942 | -7305726066363072511 |  6944590345852188420 |      0 |          20 |      565175824482554 |               13 |                        13 | E2          |         18 | A3        |   16925232 |   93856846 |              | es  
        # 68230301 |        7 |       4 |     40 | 2018-01-03 16:38:51.115407 | CMS    | 2019-04-22 19:28:30.795327 |   222399402245899264 |  -549403643646891456 |      0 |          20 |    36239903251501375 |               11 |                        11 | B3          |        -16 | D1        |   31542873 |  178244395 |              | es  
        # 68230362 |        7 |       5 |     40 | 2018-01-03 16:38:51.119255 | CMS    | 2019-04-22 19:28:30.797553 | -7997790182330891776 |  2625769870162136120 |      0 |          20 |  5227905119781154822 |               13 |                        13 | H5          |         14 | H7        |   19955349 |  122708026 |              | es  
        # 68230423 |        7 |       6 |     40 | 2018-01-03 16:38:51.12305  | CMS    | 2019-04-22 19:28:30.799864 |  2601038192983711808 |  4620975832368352530 |      0 |          20 | -9205357638345273332 |                6 |                         6 | A3          |        -22 | E2        |    8960503 |   58411859 |              | es  
        # 68230485 |        7 |       7 |     40 | 2018-01-03 16:38:51.127021 | CMS    | 2019-04-22 19:28:30.802076 | -9200314147721445312 |  8646929942227877650 |      0 |          20 |   288230379377197101 |                9 |                         9 | G2          |         20 | C8        |   12540535 |   74408936 |              | es  
        # 68230546 |        7 |       8 |     40 | 2018-01-03 16:38:51.130826 | CMS    | 2019-04-22 19:28:30.804233 |  1443650452889840158 |   154281338481606912 |      0 |          20 |  2383249729468236800 |                8 |                         8 | A3          |          0 | A6        |   28368247 |  169358336 |              | es  
        # 68230607 |        7 |       9 |     40 | 2018-01-03 16:38:51.134779 | CMS    | 2019-04-22 19:28:30.806786 |     4551398100287872 |     1341421567098479 |      0 |          20 |  1063412470602792976 |                8 |                         8 | C7          |          2 | B5        |   14538413 |   81853547 |              | es  
        # 68230117 |        7 |       1 |     40 | 2018-01-03 16:38:51.103349 | CMS    | 2019-04-22 19:28:30.788164 |    72342959909978368 |  6952639131500418064 |      0 |          20 | -8177903596017244114 |               15 |                        15 | E1          |         36 | B5        |  167141670 |  908104615 |              | es  
        insert_into_table = \
        """
        INSERT INTO regab_prng_gp (seq, batch_id, game_id, pos_id, ins_time, status, cst_time, mover,
                                   opponent, player, empty_count, legal_move_set, legal_move_count,
                                   legal_move_count_adjusted, parent_move, game_value, best_move,
                                   leaf_count, node_count, parent_gp_id, solver) VALUES
        (93262034, 7, 2, 139, '2019-04-22 19:28:32.566238', 'CMR', '2019-04-22 19:28:32.566238',    73552741720267792, -1670782510033747836, 0, 20,  1161928703928696896,  4,  4, 'H3', -38, 'UN',         0,         0, 68230178, NULL),
        (93262035, 7, 0, 139, '2019-04-22 19:28:32.568927', 'CMR', '2019-04-22 19:28:32.568927',  4645565179940044804, -7925171974899468168, 0, 20,   289075900593604224,  8,  8, 'E1', -10, 'UN',         0,         0, 68230055, NULL),
        (93262036, 7, 1, 139, '2019-04-22 19:28:32.571594', 'CMR', '2019-04-22 19:28:32.571594',    72342959236796672,  6952639132173607936, 0, 20, -7024982091410407330, 15, 15, 'F2',  34, 'UN',         0,         0, 68230116, NULL),
        (93262037, 7, 3, 139, '2019-04-22 19:28:32.573972', 'CMR', '2019-04-22 19:28:32.573972', -7305726066365030399,  6944590345854207748, 0, 20,      565175824455810, 11, 11, 'A3',   8, 'UN',         0,         0, 68230239, NULL), 
        (93262038, 7, 4, 139, '2019-04-22 19:28:32.576182', 'CMR', '2019-04-22 19:28:32.576182',   222399332786127872,  -549403436748297664, 0, 20,    36099715523285273, 10, 10, 'F5', -16, 'UN',         0,         0, 68230300, NULL),
        (93262039, 7, 5, 139, '2019-04-22 19:28:32.578391', 'CMR', '2019-04-22 19:28:32.578391', -9150711684790255104,  4355151575169109048, 0, 20,  4615345751470403590, 11, 11, 'D8',   6, 'UN',         0,         0, 68230361, NULL),
        (93262040, 7, 6, 139, '2019-04-22 19:28:32.580585', 'CMR', '2019-04-22 19:28:32.580585',  2601038192983711808,  4620975832368352530, 0, 20, -9205357638345273332,  6,  6, 'A3', -22, 'UN',         0,         0, 68230422, NULL),
        (93262041, 7, 7, 139, '2019-04-22 19:28:32.582653', 'CMR', '2019-04-22 19:28:32.582653', -9200314147721445312,  8646929942227861298, 0, 20,   288230379377197069,  8,  8, 'F1',   2, 'UN',         0,         0, 68230484, NULL),
        (93262042, 7, 8, 139, '2019-04-22 19:28:32.584767', 'CMR', '2019-04-22 19:28:32.584767',  1443650452906609182,   154281338464772384, 0, 20,  2383249729468302400, 10, 10, 'F1', -10, 'UN',         0,         0, 68230545, NULL),
        (93262043, 7, 9, 139, '2019-04-22 19:28:32.586884', 'CMR', '2019-04-22 19:28:32.586884',     4555813292851584,      211110762659439, 0, 20,    54043204135157776,  5,  5, 'A5', -20, 'UN',         0,         0, 68230606, NULL),
        (68230056, 7, 0,  40, '2018-01-03 16:38:51.098362', 'CMS', '2019-04-22 19:28:30.785500',  4611717676283199524, -7855295674223658936, 0, 20,  3171520399607465616, 13, 13, 'H7',  10, 'F8',   8265202,  45798972,     NULL, 'es'),
        (68230179, 7, 2,  40, '2018-01-03 16:38:51.107351', 'CMS', '2019-04-22 19:28:30.790570',    73548482186484752, -1670215300554932092, 0, 20,  1596526067978346560,  9,  9, 'B7', -22, 'H3',   6488992,  38225062,     NULL, 'es'),
        (68230240, 7, 3,  40, '2018-01-03 16:38:51.111269', 'CMS', '2019-04-22 19:28:30.792942', -7305726066363072511,  6944590345852188420, 0, 20,      565175824482554, 13, 13, 'E2',  18, 'A3',  16925232,  93856846,     NULL, 'es'),
        (68230301, 7, 4,  40, '2018-01-03 16:38:51.115407', 'CMS', '2019-04-22 19:28:30.795327',   222399402245899264,  -549403643646891456, 0, 20,    36239903251501375, 11, 11, 'B3', -16, 'D1',  31542873, 178244395,     NULL, 'es'),
        (68230362, 7, 5,  40, '2018-01-03 16:38:51.119255', 'CMS', '2019-04-22 19:28:30.797553', -7997790182330891776,  2625769870162136120, 0, 20,  5227905119781154822, 13, 13, 'H5',  14, 'H7',  19955349, 122708026,     NULL, 'es'),
        (68230423, 7, 6,  40, '2018-01-03 16:38:51.123050', 'CMS', '2019-04-22 19:28:30.799864',  2601038192983711808,  4620975832368352530, 0, 20, -9205357638345273332,  6,  6, 'A3', -22, 'E2',   8960503,  58411859,     NULL, 'es'),
        (68230485, 7, 7,  40, '2018-01-03 16:38:51.127021', 'CMS', '2019-04-22 19:28:30.802076', -9200314147721445312,  8646929942227877650, 0, 20,   288230379377197101,  9,  9, 'G2',  20, 'C8',  12540535,  74408936,     NULL, 'es'),
        (68230546, 7, 8,  40, '2018-01-03 16:38:51.130826', 'CMS', '2019-04-22 19:28:30.804233',  1443650452889840158,   154281338481606912, 0, 20,  2383249729468236800,  8,  8, 'A3',   0, 'A6',  28368247, 169358336,     NULL, 'es'),
        (68230607, 7, 9,  40, '2018-01-03 16:38:51.134779', 'CMS', '2019-04-22 19:28:30.806786',     4551398100287872,     1341421567098479, 0, 20,  1063412470602792976,  8,  8, 'C7',   2, 'B5',  14538413,  81853547,     NULL, 'es'),
        (68230117, 7, 1,  40, '2018-01-03 16:38:51.103349', 'CMS', '2019-04-22 19:28:30.788164',    72342959909978368,  6952639131500418064, 0, 20, -8177903596017244114, 15, 15, 'E1',  36, 'B5', 167141670, 908104615,     NULL, 'es');
        """

        self.conn = duckdb.connect(database=':memory:')
        self.conn.execute(create_table)
        self.conn.execute(insert_into_table)

    def tearDown(self):
        self.conn.close()

    def test_rglm_dummy(self):
        self.assertEqual(1, 1)

    def test_rglm_basics(self):
        m = Rglm() \
            .set_empty_count(12) \
            .set_batches(8) \
            .set_statuses('CMP')
        self.assertIsInstance(m, Rglm)

    def test_rglm_connection(self):
        m = Rglm() \
            .set_conn(RegabDBConnection.new_duckdb(self.conn))
        self.assertIsInstance(m, Rglm)
        m.close_conn()

    def test_rglm_creation(self):
        m = Rglm() \
            .set_conn(RegabDBConnection.new_duckdb(self.conn)) \
            .set_empty_count(20) \
            .set_batches(7) \
            .set_vld_batches(7) \
            .set_statuses('CMR,CMS') \
            .set_vld_statuses('CMR,CMS') \
            .retrieve_game_positions() \
            .retrieve_vld_game_positions() \
            .set_features('INTERCEPT,MOBILITY3') \
            .set_patterns('EDGE,DIAG8') \
            .compute_feature_values() \
            .compute_indexes() \
            .combine_gps_features_patterns() \
            .compute_vmaps() \
            .compute_gpxpidf() \
            .compute_x() \
            .compute_y()
        
        self.assertIsInstance(m, Rglm)
        m.close_conn()

