#
# evaluation_function_fit_statistics.R
#
# Copyright (c) 2019 Roberto Corradini. All rights reserved.
#
# This file is part of the reversi program
# http://github.com/rcrr/reversi
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 3, or (at your option) any
# later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
# or visit the site <http://www.gnu.org/licenses/>.
#
#
#
# This script prepares a few plots that present the data generated by the rglm_fit_utility program.
# Change the data file variable to load the corret CSV file
#
# g_gvf plots: x = GV (Game Value), y = GVF (Game Value Frequency)
# It gives the frequency distribution of the true, exact, game outcomes.
#
# g_eff plots: x = EF (Evaluation Function), y = EFF (Evaluation Function Frequency)
# It gives the frequency distribution of the outcomes computed by the evaluation function.
#
# g_efef plots: x = EFE (Evaluation Function Error), y = EFEF (Evaluation Function Error Frequency)
# It gives the frequency distribution of the error collected by the evaluation function.
#

data_file <- '../out/ec20/ALL/eval_ec_20_bid_03_by_bid_03_p_ALL_s_CMS-CMR_01_weights.csv'

library(ggplot2)
library(data.table)
library(grid)
library(gridExtra)

game_value <- function(fvalue) {
  # fvalue * a + b = ivalue
  # .99 * a + b = +64
  # .01 * a + b = -64
  # a + 2b = 0
  # .98 a = 128
  # a = 128/.98
  # b = -64/.98
  ivalue <- 2. * round((32./.98) * (2. * fvalue - 1.))
  return(as.integer(ivalue))
}

xlim_lower <- -128
xlim_upper <- +128

setwd('/home/rcrr/base/prj/reversi/c/r')

dt <- fread(data_file)
dt <- dt[,.(GP_ID, GV = GAME_VALUE, EF = game_value(EVALUATION_FUNCTION))]

game_position_count <- dt[,.N]

# EFE is Evaluation Function Error
dt[, EFE := EF - GV]

# Mean of Game Value, Evaluation Function, and Evaluation Function Error
means <- colMeans(dt[,.(GV, EF, EFE)])
# Standard Deviation of Game Value, Evaluation Function, and Evaluation Function Error
#   Hint: to get the value of the standard deviation for the EFE column use the expression: sds['EFE']
sds <- sapply(dt[,.(GV, EF, EFE)], sd)

f <- data.table(GV = as.integer(seq(from = -64, to = +64, by = 2)))
setkey(f, GV)
stopifnot(f[,.N] == 65)

# Frequency of game values (GVF: Game Value Frequency)
dt_gvf <- dt[,.(GVF = .N), by = GV]
setkey(dt_gvf, GV)
stopifnot(dt_gvf[,sum(GVF)] == game_position_count)
dt_gvf[, GVP := GVF / game_position_count]
stopifnot(dt_gvf[,sum(GVP)] == 1.0)

# Frequency of Evaluation Function (EFF: Evaluation Function Frequency)
dt_eff <- dt[,.(EFF = .N), by = EF]
setkey(dt_eff, EF)
stopifnot(dt_eff[,sum(EFF)] == game_position_count)
dt_eff[, EFP := EFF / game_position_count]
stopifnot(dt_eff[,sum(EFP)] == 1.0)

dt_efef <- dt[, .(EFEF = .N), by = EFE]
setkey(dt_efef, EFE)
stopifnot(dt_efef[,sum(EFEF)] == game_position_count)
dt_efef[, EFEP := EFEF / game_position_count]
stopifnot(dt_efef[,sum(EFEP)] == 1.0)

# Joins frequncies into the f data table
f <- dt_eff[dt_gvf[f]]
f[is.na(f)] <- 0.
setnames(f, c("OUTCOME", "EFF", "EFP", "GVF", "GVP"))
setcolorder(f, c("OUTCOME", "GVF", "GVP", "EFF", "EFP"))
stopifnot(f[,.N] == 65)
stopifnot(f[,sum(GVF)] == game_position_count)
stopifnot(f[,sum(GVP)] == 1.0)
stopifnot(f[,sum(EFF)] == game_position_count)
stopifnot(f[,sum(EFP)] == 1.0)

ylim_p_lower <- 0.00
ylim_p_upper <- ceiling(max(max(dt_gvf[,GVP]), max(dt_eff[,EFP]), dt_efef[, EFEP]) * 100) / 100.

theme <- theme(
  plot.title = element_text(color = "black", size = 12, face = "bold", hjust = 1),
  axis.title.x = element_text(color="black", size=10, face="italic"),
  axis.title.y = element_text(color="black", size=10, face="italic")
)

g_gvp <- ggplot(dt_gvf, aes(x = GV, y = GVP)) + 
  geom_bar(stat = "identity", color = "black", fill = "gray") +
  xlim(xlim_lower, xlim_upper) +
  ylim(ylim_p_lower, ylim_p_upper) +
  labs(title = "Exact Game Outcome Prob. Distrib.") +
  xlab("Game Outcome") +
  ylab("Probability") +
  theme +
  geom_label(x = xlim_upper - 2, y = ylim_p_upper - 0.005, size = 4, color = "grey", hjust = "inward",
             label = paste0("Sample size: ", format(game_position_count, big.mark = ","),
                            "\nMean: ", round(means['GV'], digits = 2),
                            "\nSD: ", round(sds['GV'], digits = 2)))
g_efp <- ggplot(dt_eff, aes(x = EF, y = EFP)) +
  geom_bar(stat = "identity", color = "blue", fill = "azure") +
  xlim(xlim_lower, xlim_upper) +
  ylim(ylim_p_lower, ylim_p_upper) +
  labs(title = "Evaluation Function Prob. Distrib.") +
  xlab("Predicted Outcome") +
  ylab("Probability") +
  theme +
  geom_label(x = xlim_upper - 2, y = ylim_p_upper - 0.005, size = 4, color = "grey", hjust = "inward",
             label = paste0("Mean: ", round(means['EF'], digits = 2),
                            "\nSD: ", round(sds['EF'], digits = 2)))
g_efep <- ggplot(dt_efef, aes(x = EFE, y = EFEP)) +
  geom_bar(stat = "identity", color = "red", fill = "orange") +
  xlim(xlim_lower, xlim_upper) +
  ylim(ylim_p_lower, ylim_p_upper) +
  labs(title = "Evaluation Function Error Prob. Distrib.") +
  xlab("Deviation between the predicted and the true values") +
  ylab("Probability") +
  theme +
  geom_label(x = xlim_upper - 2, y = ylim_p_upper - 0.005, size = 4, color = "grey", hjust = "inward",
             label = paste0("Mean: ", round(means['EFE'], digits = 2),
                            "\nSD: ", round(sds['EFE'], digits = 2)))

blankPanel <- grid.rect(gp=gpar(col="white"))

g0 <- tableGrob(d = data.frame(Key = c("Blind SD","AI SD"), Value = c(sds['GV'], sds['EFE'])))

g <- grid.arrange(g0, g_gvp, g_efp, g_efep, ncol = 2,
                  top = textGrob(paste("Input data file:", data_file, sep = " "),
                                 gp = gpar(fontsize = 10, font = 3)))

