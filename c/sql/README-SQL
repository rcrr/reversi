
  README-SQL

  Copyright (c) 2015, 2018, 2019, 2020, 2024 Roberto Corradini. All rights reserved.

  This file is part of the reversi program
  http://github.com/rcrr/reversi

  This program is free software; you can redistribute it and/or modify it
  under the terms of the GNU General Public License as published by the
  Free Software Foundation; either version 3, or (at your option) any
  later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
  or visit the site <http://www.gnu.org/licenses/>.

This file describes the configuration and settings done to prepare the SQL environment used to develop and execute
the REVERSI program.

Software components being used are:

 - Debian GNU/Linux 12 (bookworm) - Linux kernel 6.1.0-26-amd64
 - PostgreSQL 16.4 (Debian 16.4-1.pgdg120+2)

A few useful commands:

To connect as postgres user:
 $ sudo su - postgres

To connect to PostgreSQL as superuser:
 $ sudo -u postgres psql postgres
or:
 $ sudo su - postgres
 $ psql -U postgres

When connected as postgres user (superuser):

 -- Double dash is a standard SQL comment.

 -- Lists the existing databases.
 postgres=# \list
 postgres=# \l+

 -- Lists the existing tablespaces.
 postgres=# \db+

 -- Shows where phisical database files are stored.
 postgres=# SHOW data_directory;

 -- Lists users.
 postgres=# SELECT rolname FROM pg_roles;

 -- Creates user 'es'.
 postgres=# CREATE ROLE es LOGIN;
 postgres=# ALTER ROLE es WITH PASSWORD 'es';
 postgres=# ALTER ROLE es VALID UNTIL 'infinity';
 
 -- Drops user 'es'.
 postgres=# DROP ROLE es;
 
 -- Creates tablespace 'es' in directory '/data/postgres/12/es'. The directory must exists and created by user postgres.
 postgres=# CREATE TABLESPACE es LOCATION '/data/postgres/12/es';

 -- Drops tablespace 'es'.
 postgres=# DROP TABLESPACE es;

 -- Creates database 'es'.
 postgres=# CREATE DATABASE es WITH OWNER es ENCODING 'UTF8' TABLESPACE es;

 -- Drops database 'es'.
 postgres=# DROP DATABASE es;

 -- Given that we have an 'es' database on an 'es' tablespace, owned by an 'es' user, generated by:
 postgres=# CREATE ROLE es LOGIN;
 postgres=# ALTER ROLE es WITH PASSWORD 'es';
 postgres=# ALTER ROLE es VALID UNTIL 'infinity';
 postgres=# CREATE TABLESPACE es LOCATION '/data/postgres/12/es';
 postgres=# CREATE DATABASE es WITH OWNER es ENCODING 'UTF8' TABLESPACE es;
 postgres=# GRANT ALL PRIVILEGES ON DATABASE es TO es;

Edit file .pgpass in your home directory and add a line like this:
localhost:5432:*:es:es
127.0.0.1:5432:*:es:es
 
We can connect to the new db by:
 $ psql -U es -d es -h localhost

In order to run the complete suite on db 'es' as user 'es'
 $ time psql -U es -d es -h localhost -c "\i reload_everything.sql"
 $ time psql -U es -d es -h localhost -c "\i 0100_up_regab_create_schema.sql"
 $ time psql -U es -d es -h localhost -c "\i 0101_up_migrations.sql"
 $ time psql -U es -d es -h localhost -c "\i 0102_up_gp_ext.sql"
 $ time psql -U es -d es -h localhost -c "\i 0103_up_patterns.sql"
 $ time psql -U es -d es -h localhost -c "\i 0104_up_pattern_functions.sql"
 $ time psql -U es -d es -h localhost -c "\i 0107_up_pattern_data.sql"
 $ time psql -U es -d es -h localhost -c "\i 0109_up_action_extract.sql"
 $ time psql -U es -d es -h localhost -c "\i 0110_up_gp_solver.sql"

 --
 -- Backup and restore procedure.
 --
 --
 -- Backup using the pg_dump utility:
 -- -d database_name
 -- -h hostname
 -- -p port
 -- -U user (it must be postgres or equivalent superuser)
 -- -v verbose output
 -- -Z compression level 0..9 (more than 4 gives back small benefit)
 -- -f target filename - selected format is YYYYMMDDHHMM-hostname-database_name.dump
 -- output redirected to a proper log file (same name convention
 --
$ pg_dump -d backup_db_name -h localhost -p 5432 -U postgres -v -Fc -Z2 -f out/201801031517-localhost-backup_db_name.dump 2> out/201801031517-localhost-backup_db_name.log
 -- or in background:
$ nohup time pg_dump -d backup_db_name -h localhost -p 5432 -U postgres -v -Fc -Z2 -f out/201801031517-localhost-backup_db_name.dump > out/201801031517-localhost-backup_db_name.log 2>&1& 
 --
 -- Given that we have a user named 'restore_db_name', and a tablespace with the same name, we can restore the dump by:
 postgres=# DROP DATABASE restore_db_name;
 postgres=# CREATE DATABASE restore_db_name WITH OWNER restore_db_name ENCODING 'UTF8' TABLESPACE restore_db_name;
 postgres=# GRANT ALL PRIVILEGES ON DATABASE restore_db_name TO restore_db_name;
 --
 -- Next time try to use the flag --jobs=number-of-job when restoring the DB ....
 --
 $ pg_restore --no-acl --no-owner -v -d restore_db_name -p 5432 -h localhost -U restore_db_name out/201801031517-localhost-backup_db_name.dump
 --
 -- Note: to avoid errors on setting the COMMENT on EXTENSION plpgsql, hstore, and uuid-ossp, like the following:
 --
    pg_restore: creating EXTENSION plpgsql
    pg_restore: creating COMMENT EXTENSION plpgsql
    pg_restore: [archiver (db)] Error while PROCESSING TOC:
    pg_restore: [archiver (db)] Error from TOC entry 2349; 0 0 COMMENT EXTENSION plpgsql 
    pg_restore: [archiver (db)] could not execute query: ERROR:  must be owner of extension plpgsql
        Command was: COMMENT ON EXTENSION plpgsql IS 'PL/pgSQL procedural language';
 --
 -- connect to the backup_db_name as postgres by:
 $ psql -U postgres -d backup_db_name -h localhost
 -- then issue these commands:
 # COMMENT ON EXTENSION plpgsql IS NULL;
 -- After this change perform the database dump.

--
--
-- 2021-02-27
--
-- Upgrade postgresql from 12.6 to 13.2
--
--

 $ sudo su - postgres

 $ psql -U postgres -p 5432 -c "SELECT version();"
                                                              version                                                              
 ----------------------------------------------------------------------------------------------------------------------------------
  PostgreSQL 12.6 (Ubuntu 12.6-1.pgdg20.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0, 64-bit
 (1 row)

 $ psql -U postgres -p 5433 -c "SELECT version();"
                                                             version                                                              
 ----------------------------------------------------------------------------------------------------------------------------------
  PostgreSQL 13.2 (Ubuntu 13.2-1.pgdg20.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0, 64-bit
 (1 row)

 $ mkdir /data/postgres/13
 $ mkdir /data/postgres/13/es

 $ psql -U postgres -p 5433
 psql (13.2 (Ubuntu 13.2-1.pgdg20.04+1))
 Type "help" for help.

 -- Given that we have an 'es' database on an 'es' tablespace, owned by an 'es' user, generated by:
 postgres=# CREATE ROLE es LOGIN;
 postgres=# ALTER ROLE es WITH PASSWORD 'es';
 postgres=# ALTER ROLE es VALID UNTIL 'infinity';
 postgres=# CREATE TABLESPACE es LOCATION '/data/postgres/13/es';
 postgres=# CREATE DATABASE es WITH OWNER es ENCODING 'UTF8' TABLESPACE es;
 postgres=# GRANT ALL PRIVILEGES ON DATABASE es TO es;

Edit file .pgpass in your home directory and add a line like this:
localhost:5433:*:es:es
127.0.0.1:5433:*:es:es

Be sure to have prepated needed files by running:
 $ make endgame_pv_files
 $ make endgame_log_files
 $ make dat2csv 
 
We can connect to the new db by:
 $ psql -U es -d es -h localhost -p 5433

In order to run the complete suite on db 'es' as user 'es':
 $ time psql -U es -d es -h localhost -p 5433 -c "\i reload_everything.sql"
 $ time psql -U es -d es -h localhost -p 5433 -c "\i 0100_up_regab_create_schema.sql"
 $ time psql -U es -d es -h localhost -p 5433 -c "\i 0101_up_migrations.sql"
 $ time psql -U es -d es -h localhost -p 5433 -c "\i 0102_up_gp_ext.sql"
 $ time psql -U es -d es -h localhost -p 5433 -c "\i 0103_up_patterns.sql"
 $ time psql -U es -d es -h localhost -p 5433 -c "\i 0104_up_pattern_functions.sql"
 $ time psql -U es -d es -h localhost -p 5433 -c "\i 0107_up_pattern_data.sql"
 $ time psql -U es -d es -h localhost -p 5433 -c "\i 0109_up_action_extract.sql"
 $ time psql -U es -d es -h localhost -p 5433 -c "\i 0110_up_gp_solver.sql "

--
-- The es database is completed.
--

 $ mkdir /data/postgres/13/tst_regab

 postgres=# CREATE ROLE tst_regab LOGIN;
 postgres=# ALTER ROLE tst_regab WITH PASSWORD 'tst_regab';
 postgres=# ALTER ROLE tst_regab VALID UNTIL 'infinity';
 postgres=# CREATE TABLESPACE tst_regab LOCATION '/data/postgres/13/tst_regab';
 postgres=# CREATE DATABASE tst_regab WITH OWNER tst_regab ENCODING 'UTF8' TABLESPACE tst_regab;
 postgres=# GRANT ALL PRIVILEGES ON DATABASE tst_regab TO tst_regab;

 $ pg_restore --no-acl --no-owner -v -d tst_regab -p 5433 -h localhost -U tst_regab 202102211228-vilya-prd_regab.dump

Edit the /etc/postgresql/13/main/postgresql.conf file.

Connect to postgresql 12 as postgres, and drop the es and tst_regab databases.

$ psql -U postgres -p 5432
psql (13.2 (Ubuntu 13.2-1.pgdg20.04+1), server 12.6 (Ubuntu 12.6-1.pgdg20.04+1))
Type "help" for help.

postgres=# \l
                                   List of databases
   Name    |   Owner   | Encoding |   Collate   |    Ctype    |    Access privileges    
-----------+-----------+----------+-------------+-------------+-------------------------
 es        | es        | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =Tc/es                 +
           |           |          |             |             | es=CTc/es
 postgres  | postgres  | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 template0 | postgres  | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres            +
           |           |          |             |             | postgres=CTc/postgres
 template1 | postgres  | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres            +
           |           |          |             |             | postgres=CTc/postgres
 tst_regab | tst_regab | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =Tc/tst_regab          +
           |           |          |             |             | tst_regab=CTc/tst_regab
(5 rows)

postgres=# DROP DATABASE tst_regab;
DROP DATABASE
postgres=# DROP DATABASE es;
DROP DATABASE
postgres=# \l
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(3 rows)


-- Stop the postgres service:

 $ sudo service --status-all | grep postgresql
  [ + ]  postgresql
 $ sudo service postgresql stop
 $ sudo service --status-all | grep postgresql
  [ - ]  postgresql


-- Remove the postgres 12 software:

 $ sudo apt remove postgresql-12 postgresql-server-dev-12 postgresql-client-12

-- Change listening port from 5433 to 5432.
-- Restart postgresql.

 $ sudo service postgresql start
 $ sudo service --status-all | grep postgresql
 [ + ]  postgresql

--
-- Upgrade postgresql from 12.6 to 13.2 - DONE
--

--
--
--
--
--

--
--
-- 2024-10-31
--
-- Upgrade postgresql from 16.4 to 17.0
--
--

$ psql -p 5432
psql (17.0 (Debian 17.0-1.pgdg120+1), server 16.4 (Debian 16.4-1.pgdg120+2))
Type "help" for help.

postgres=# \l+
                                                                                         List of databases
   Name    |   Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | Locale | ICU Rules |    Access privileges    |  Size   | Tablespace |                Description                 
-----------+-----------+----------+-----------------+-------------+-------------+--------+-----------+-------------------------+---------+------------+--------------------------------------------
 es        | es        | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =Tc/es                 +| 6192 MB | es         | 
           |           |          |                 |             |             |        |           | es=CTc/es               |         |            | 
 postgres  | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           |                         | 7492 kB | pg_default | default administrative connection database
 prd_regab | prd_regab | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =Tc/prd_regab          +| 249 GB  | prd_regab  | 
           |           |          |                 |             |             |        |           | prd_regab=CTc/prd_regab |         |            | 
 qty_regab | qty_regab | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           |                         | 249 GB  | qty_regab  | 
 template0 | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres            +| 7337 kB | pg_default | unmodifiable empty database
           |           |          |                 |             |             |        |           | postgres=CTc/postgres   |         |            | 
 template1 | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres            +| 7556 kB | pg_default | default template for new databases
           |           |          |                 |             |             |        |           | postgres=CTc/postgres   |         |            | 
 tst_regab | tst_regab | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =Tc/tst_regab          +| 249 GB  | tst_regab  | 
           |           |          |                 |             |             |        |           | tst_regab=CTc/tst_regab |         |            | 
(7 rows)

postgres=# 
\q

$ psql -p 5433
psql (17.0 (Debian 17.0-1.pgdg120+1))
Type "help" for help.

postgres=# \l+
                                                                                       List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | Locale | ICU Rules |   Access privileges   |  Size   | Tablespace |                Description                 
-----------+----------+----------+-----------------+-------------+-------------+--------+-----------+-----------------------+---------+------------+--------------------------------------------
 postgres  | postgres | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           |                       | 7475 kB | pg_default | default administrative connection database
 template0 | postgres | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres          +| 7321 kB | pg_default | unmodifiable empty database
           |          |          |                 |             |             |        |           | postgres=CTc/postgres |         |            | 
 template1 | postgres | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres          +| 7547 kB | pg_default | default template for new databases
           |          |          |                 |             |             |        |           | postgres=CTc/postgres |         |            | 
(3 rows)

-
- First thing is to take a BACKUP of the production database
-

$ DATE=`date '+%Y%m%d%H%M'
$ nohup time pg_dump -d backup_db_name -h backup_host_name -p 5432 -U postgres -v -Fc -Z2 -f $DATE-backup_host_name-prd_regab.dump > $DATE-backup_host_name-prd_regab.log 2>&1&

-
- Configure postgresql server ...
-

- Add this line to file /etc/postgresql/17/main/pg_hba.conf

# rcrr 2024-11-01
host    all             all             10.101.37.0/24          md5

- Edit file /etc/postgresql/17/main/postgresql.conf adding/modifying:

listen_addresses = '*'
max_connections = 200
shared_buffers = 4GB
work_mem = 16GB
maintenance_work_mem = 64MB
effective_io_concurrency = 400
max_worker_processes = 8
max_parallel_maintenance_workers = 8
max_parallel_workers_per_gather = 2
parallel_leader_participation = on
max_parallel_workers = 8
wal_buffers = 64MB
max_wal_size = 8GB
min_wal_size = 4GB
random_page_cost = 1.1
effective_cache_size = 48GB

- Run as root:

# systemctl status postgresql

# systemctl restart postgresql

-
- Now should be possible to login remotly. But for testing it we need an user ...
-
- Create the directory for the TABLESPACE
- As user postgres create the directory es ....
-

$ ls -l /data/postgres/17/es/

-
- As user postgres connect to the database version 17:
-

$ psql -p 5433

postgres=# CREATE ROLE es LOGIN;
CREATE ROLE
postgres=# ALTER ROLE es WITH PASSWORD 'es';
ALTER ROLE
postgres=# ALTER ROLE es VALID UNTIL 'infinity';
ALTER ROLE
postgres=# CREATE TABLESPACE es LOCATION '/data/postgres/17/es';
CREATE TABLESPACE
postgres=# CREATE DATABASE es WITH OWNER es ENCODING 'UTF8' TABLESPACE es;
CREATE DATABASE
postgres=# GRANT ALL PRIVILEGES ON DATABASE es TO es;
GRANT

-
- Connect from another system to our database-server:
-

$ psql -h database_host -p 5433 -U es -d es
Password for user es: 
psql (17.0 (Debian 17.0-1.pgdg120+1))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off, ALPN: postgresql)
Type "help" for help.

es=>

- Adding the proper entry to file .pgpass in your home directory is avoiding to have to enter the password:

database_host:5433:*:es:es

-
- We can connect to the new db by:
-

$ psql -U es -d es -h database_host -p 5433

-
- Everything works well.
-
- Be sure to have prepated needed files by running from the REVERSI_HOME folder:
-

$ make endgame_pv_files
$ make endgame_log_files
$ make dat2csv

-
- In order to have the following procedure to run properly, unfortunately is required to add
- to HOME/.pgpass an entry with the IP ADDRESS of the database_host.
-
- Then run:
-

$ time psql -U es -d es -h database_host -p 5433 -c "\i reload_everything.sql"
$ time psql -U es -d es -h database_host -p 5433 -c "\i 0100_up_regab_create_schema.sql"
$ time psql -U es -d es -h database_host -p 5433 -c "\i 0101_up_migrations.sql"
$ time psql -U es -d es -h database_host -p 5433 -c "\i 0102_up_gp_ext.sql"
$ time psql -U es -d es -h database_host -p 5433 -c "\i 0103_up_patterns.sql"
$ time psql -U es -d es -h database_host -p 5433 -c "\i 0104_up_pattern_functions.sql"
$ time psql -U es -d es -h database_host -p 5433 -c "\i 0107_up_pattern_data.sql"
$ time psql -U es -d es -h database_host -p 5433 -c "\i 0109_up_action_extract.sql"
$ time psql -U es -d es -h database_host -p 5433 -c "\i 0110_up_gp_solver.sql "

--
-- The es database is completed.
--

--
-- Load the tst_regab database ....
--
-- Prepare the tablespace directory
-- add the proper entries to .pgpass
--

postgres=# CREATE ROLE tst_regab LOGIN;
CREATE ROLE
postgres=# ALTER ROLE tst_regab WITH PASSWORD 'tst_regab';
ALTER ROLE
postgres=# ALTER ROLE tst_regab VALID UNTIL 'infinity';
ALTER ROLE
postgres=# CREATE TABLESPACE tst_regab LOCATION '/data/postgres/17/tst_regab';
CREATE TABLESPACE
postgres=# CREATE DATABASE tst_regab WITH OWNER tst_regab ENCODING 'UTF8' TABLESPACE tst_regab;
CREATE DATABASE
postgres=# GRANT ALL PRIVILEGES ON DATABASE tst_regab TO tst_regab;
GRANT

--
-- Add an entry, if missing, on the database_host .pgpass file:
--

localhost:5433:*:tst_regab:tst_regab

--
-- On the database_host load the dump file.
--

$ pg_restore --no-acl --no-owner -v -d tst_regab -p 5433 -h localhost -U tst_regab regab_database_backup_from_production.dump

--
-- When completed, connect and test it. It works!
--

postgres=# SELECT version();
                                                       version                                                       
---------------------------------------------------------------------------------------------------------------------
 PostgreSQL 17.0 (Debian 17.0-1.pgdg120+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 12.2.0-14) 12.2.0, 64-bit
(1 row)

postgres=# \l+
                                                                                         List of databases
   Name    |   Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | Locale | ICU Rules |    Access privileges    |  Size   | Tablespace |                Description                 
-----------+-----------+----------+-----------------+-------------+-------------+--------+-----------+-------------------------+---------+------------+--------------------------------------------
 es        | es        | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =Tc/es                 +| 6191 MB | es         | 
           |           |          |                 |             |             |        |           | es=CTc/es               |         |            | 
 postgres  | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           |                         | 7483 kB | pg_default | default administrative connection database
 template0 | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres            +| 7321 kB | pg_default | unmodifiable empty database
           |           |          |                 |             |             |        |           | postgres=CTc/postgres   |         |            | 
 template1 | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres            +| 7547 kB | pg_default | default template for new databases
           |           |          |                 |             |             |        |           | postgres=CTc/postgres   |         |            | 
 tst_regab | tst_regab | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =Tc/tst_regab          +| 249 GB  | tst_regab  | 
           |           |          |                 |             |             |        |           | tst_regab=CTc/tst_regab |         |            | 
(5 rows)

--

postgres=# SELECT version();
                                                       version                                                       
---------------------------------------------------------------------------------------------------------------------
 PostgreSQL 16.4 (Debian 16.4-1.pgdg120+2) on x86_64-pc-linux-gnu, compiled by gcc (Debian 12.2.0-14) 12.2.0, 64-bit
(1 row)

postgres=# \l+
                                                                                         List of databases
   Name    |   Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | Locale | ICU Rules |    Access privileges    |  Size   | Tablespace |                Description                 
-----------+-----------+----------+-----------------+-------------+-------------+--------+-----------+-------------------------+---------+------------+--------------------------------------------
 es        | es        | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =Tc/es                 +| 6192 MB | es         | 
           |           |          |                 |             |             |        |           | es=CTc/es               |         |            | 
 postgres  | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           |                         | 7492 kB | pg_default | default administrative connection database
 prd_regab | prd_regab | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =Tc/prd_regab          +| 249 GB  | prd_regab  | 
           |           |          |                 |             |             |        |           | prd_regab=CTc/prd_regab |         |            | 
 qty_regab | qty_regab | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           |                         | 249 GB  | qty_regab  | 
 template0 | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres            +| 7337 kB | pg_default | unmodifiable empty database
           |           |          |                 |             |             |        |           | postgres=CTc/postgres   |         |            | 
 template1 | postgres  | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres            +| 7556 kB | pg_default | default template for new databases
           |           |          |                 |             |             |        |           | postgres=CTc/postgres   |         |            | 
 tst_regab | tst_regab | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =Tc/tst_regab          +| 249 GB  | tst_regab  | 
           |           |          |                 |             |             |        |           | tst_regab=CTc/tst_regab |         |            | 
(7 rows)

--
-- We have 2 databases on version 17.0: es and tst_regab
--
-- Now that we have the latest production database restored into our test env on v17.0, we can start removing
-- databases from the postgresql v16.4 installation.
--

postgres=# SELECT version();
                                                       version                                                       
---------------------------------------------------------------------------------------------------------------------
 PostgreSQL 16.4 (Debian 16.4-1.pgdg120+2) on x86_64-pc-linux-gnu, compiled by gcc (Debian 12.2.0-14) 12.2.0, 64-bit
(1 row)

postgres=# DROP DATABASE es;
DROP DATABASE
postgres=# DROP DATABASE tst_regab;
DROP DATABASE
postgres=# DROP DATABASE qty_regab;
DROP DATABASE
postgres=# DROP DATABASE prd_regab;
DROP DATABASE
postgres=# \l+
                                                                                       List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | Locale | ICU Rules |   Access privileges   |  Size   | Tablespace |                Description                 
-----------+----------+----------+-----------------+-------------+-------------+--------+-----------+-----------------------+---------+------------+--------------------------------------------
 postgres  | postgres | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           |                       | 7492 kB | pg_default | default administrative connection database
 template0 | postgres | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres          +| 7337 kB | pg_default | unmodifiable empty database
           |          |          |                 |             |             |        |           | postgres=CTc/postgres |         |            | 
 template1 | postgres | UTF8     | libc            | en_GB.UTF-8 | en_GB.UTF-8 |        |           | =c/postgres          +| 7556 kB | pg_default | default template for new databases
           |          |          |                 |             |             |        |           | postgres=CTc/postgres |         |            | 
(3 rows)

--
-- Done!
--
-- Follow the same procedure done for tst_regab and create also qty_regab and prd_regab databases.
--


-- Stop the postgres service.
-- Remove the postgres 16 software.
-- Run as root:

# systemctl status postgresql

# systemctl stop postgresql

# apt remove postgresql-16 postgresql-client-16 postgresql-doc-16

-- Change listening port from 5433 to 5432.
-- Restart postgresql.

# systemctl start postgresql

--
-- Upgrade postgresql from 16.4 to 17.0 - DONE
--
